# 判断点是否落在道路的30米缓冲区内的方法

在出租车数据处理中， 一般认为距离道路超过30米的记录是异常记录， 为了识别并剔除这些异常记录，可以想到的方法
有以下几种：

1. 遍历所有道路， 计算点到道路的距离， 如果存在距离<30m的情况，则保留点
2. 为所有道路生成30m缓冲区， 遍历所有缓冲区， 判断点是否在缓冲区内部， 如果存在是的情况，则保留点。
3. 在2的基础上，为缓冲区建立rtree索引，来判断关系。
4. 在2的基础上，将所有缓冲区union为一个大的多边形（复杂多边形）， 判断点是否在多边形内部， 如果是，则保留点。


本文通过实验来实际验证究竟那种方法的效率更高。

## 实验设定
1. 深圳市osm路网
2. 1万条出租车记录

## 技术栈

1. 使用fiona进行shapefile文件读取
2. 使用shapely生成缓冲区， 合并缓冲区， 生成rtree，判断空间关系

## 实验结果
（从数据库读取出租车记录的时间被省略）
单位（s）
1. 读入路网 1.4 + 过滤时间 1272.6 = 1274
2. 读入缓冲区 3.1 + 过滤时间 890.6 + 生成缓冲区的时间 36.0 = 929.7
3. 读入缓冲区构建rtree 3.1 + 过滤时间22.93 + 生成缓冲区的时间 36.0 = 62.03
4. 读入合并缓冲 0.2 + 过滤时间7691.9 + 生成缓冲区时间 36.0 + 合并缓冲区时间98.4 = 7826.5


从结果中可以看出，使用缓冲区+rtree的方法效率最高，然后是使用缓冲区的方法，再然后是使用距离的方法，最后是合并缓冲区的方法。
使用距离的方法和使用缓冲区的方法的差异在于， 计算一次点到道路距离的时间 > 生成缓冲区再判断关系的时间， 而且缓冲区只需要生成一次。
使用缓冲区+rtree， 由于rtree索引使用包围盒，可以快速缩小要判断关系的缓冲区的数量， 对于效率大大提升。
合并缓冲区然后在判断关系的方法， 虽然判断的次数减少到1，但是合并产生的多边形是一个非常复杂的多边形，400931个顶点， 7685个内环，
导致判断的时间太长。

## 讨论

由于shapely使用的contains方法， 是基于9交关系矩形的，如果换用扫描线的方法，
判断的效率会提升，特别是对于4这种复杂矩形。需要进一步实验，确定，如果使用扫描线法，
4的效率会不会提高。

`matplotlib.path.Path.contains_point`不支持有洞的多边形。
